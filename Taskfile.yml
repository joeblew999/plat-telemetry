version: '3'

vars:
  RELEASE_REPO: joeblew999/plat-telemetry
  RELEASE_VERSION: latest
  DIST_DIR: '{{.ROOT_DIR}}/.dist'
  # Core subsystems that build binaries and run as services
  SUBSYSTEMS_BUILD: arc docs gh liftbridge nats pc sync telegraf
  # Subsystems that get released
  SUBSYSTEMS_RELEASE: arc gh liftbridge nats pc sync telegraf
  # Subsystems to build in CI (smaller set for faster iteration)
  # Note: gh is required for releases, always include it
  SUBSYSTEMS_CI: '{{.SUBSYSTEMS_CI | default "gh nats"}}'

includes:
  arc: ./arc
  docs: ./docs
  gh: ./gh
  liftbridge: ./liftbridge
  nats: ./nats
  pc: ./pc
  service: ./service
  sync: ./sync
  telegraf: ./telegraf
  test-reload: ./test-reload
  utm: ./utm

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list

  src:clone:
    desc: Clone all subsystem repositories
    cmds:
      - for: { var: SUBSYSTEMS_BUILD }
        task: '{{.ITEM}}:src:clone'

  src:update:
    desc: Update all subsystem repositories
    cmds:
      - for: { var: SUBSYSTEMS_BUILD }
        task: '{{.ITEM}}:src:update'

  bin:build:
    desc: Build all subsystems from source
    cmds:
      - for: { var: SUBSYSTEMS_BUILD }
        task: '{{.ITEM}}:bin:build'

  "bin:build:one":
    desc: "Build a single subsystem (usage: task bin:build:one SUBSYSTEM=nats)"
    vars:
      SUBSYSTEM: '{{.SUBSYSTEM | default "nats"}}'
    cmds:
      - task {{.SUBSYSTEM}}:bin:build

  "bin:download:one":
    desc: "Download a single subsystem binary (usage: task bin:download:one SUBSYSTEM=nats)"
    vars:
      SUBSYSTEM: '{{.SUBSYSTEM | default "nats"}}'
    cmds:
      - task {{.SUBSYSTEM}}:bin:download

  "src:clone:one":
    desc: "Clone a single subsystem source (usage: task src:clone:one SUBSYSTEM=nats)"
    vars:
      SUBSYSTEM: '{{.SUBSYSTEM | default "nats"}}'
    cmds:
      - task {{.SUBSYSTEM}}:src:clone

  bin:download:
    desc: Download pre-built binaries from release (for users)
    cmds:
      - for: { var: SUBSYSTEMS_BUILD }
        task: '{{.ITEM}}:bin:download'

  ensure:all:
    desc: Ensure all binaries exist (download or build)
    cmds:
      - for: { var: SUBSYSTEMS_BUILD }
        task: '{{.ITEM}}:ensure'

  ci:ensure:
    desc: Ensure CI subsystem binaries exist (uses SUBSYSTEMS_CI var)
    cmds:
      - for: { var: SUBSYSTEMS_CI }
        task: '{{.ITEM}}:ensure'

  bin:verify:
    desc: Verify all binary versions exist and checksums match
    cmds:
      - |
        echo "=== Binary Version Verification ==="
        ERRORS=0

        # Map subsystem to binary name
        declare -A BINARIES
        BINARIES[arc]="arc"
        BINARIES[liftbridge]="liftbridge"
        BINARIES[nats]="nats-server"
        BINARIES[pc]="process-compose"
        BINARIES[telegraf]="telegraf"

        for subsystem in arc liftbridge nats pc telegraf; do
          BINARY_NAME="${BINARIES[$subsystem]}"
          BINARY_PATH="$subsystem/.bin/$BINARY_NAME"

          # Check binary exists
          if [ ! -f "$BINARY_PATH" ]; then
            echo "❌ $subsystem: Binary not found at $BINARY_PATH"
            ERRORS=$((ERRORS + 1))
            continue
          fi

          # Check version file exists
          if [ ! -f "$subsystem/.bin/.version" ]; then
            echo "❌ $subsystem: No .version file"
            ERRORS=$((ERRORS + 1))
            continue
          fi

          # Verify checksum matches
          RECORDED_CHECKSUM=$(grep "^checksum:" "$subsystem/.bin/.version" | awk '{print $2}')
          ACTUAL_CHECKSUM=$(shasum -a 256 "$BINARY_PATH" | awk '{print $1}')

          if [ "$RECORDED_CHECKSUM" != "$ACTUAL_CHECKSUM" ]; then
            echo "❌ $subsystem: Checksum mismatch!"
            echo "  Recorded: $RECORDED_CHECKSUM"
            echo "  Actual:   $ACTUAL_CHECKSUM"
            echo "  → Binary modified after .version was created"
            ERRORS=$((ERRORS + 1))
            continue
          fi

          echo "✓ $subsystem: checksum verified"
        done

        if [ $ERRORS -gt 0 ]; then
          echo ""
          echo "❌ $ERRORS subsystems have version issues"
          echo "Run 'task bin:build' to rebuild affected binaries"
          exit 1
        else
          echo ""
          echo "✅ All binaries verified with matching checksums"
        fi

  bin:versions:
    desc: Show all binary versions (non-failing)
    cmds:
      - |
        echo "=== Binary Versions ==="
        for subsystem in arc liftbridge nats pc telegraf; do
          echo "--- $subsystem ---"
          if [ -f "$subsystem/.bin/.version" ]; then
            cat "$subsystem/.bin/.version"
          else
            echo "No version file"
          fi
          echo ""
        done

  bin:verify:running:
    desc: Verify running processes match on-disk binary versions
    cmds:
      - |
        echo "=== Running Process Version Verification ==="

        # Check if PC is running
        if ! curl -s --unix-socket pc/.pc.sock http://localhost/processes >/dev/null 2>&1; then
          echo "⚠️  Process Compose not running"
          exit 0
        fi

        ERRORS=0

        for proc in arc liftbridge nats telegraf; do
          if [ ! -f "$proc/.bin/.version" ]; then
            continue
          fi

          EXPECTED_CHECKSUM=$(grep "^checksum:" "$proc/.bin/.version" | awk '{print $2}')

          # Get running PID
          PID=$(curl -s --unix-socket pc/.pc.sock http://localhost/processes 2>/dev/null | \
            python3 -c "import sys, json; procs = json.load(sys.stdin)['data']; proc = next((p for p in procs if p['name'] == '$proc'), None); print(proc['pid'] if proc and proc['status'] == 'Running' else '')" 2>/dev/null)

          if [ -z "$PID" ]; then
            echo "⚠️  $proc: Not running"
            continue
          fi

          # Get binary path from running process
          case "$proc" in
            nats) BIN_NAME="nats-server" ;;
            *) BIN_NAME="$proc" ;;
          esac

          RUNNING_BIN=$(lsof -p "$PID" 2>/dev/null | grep "/$BIN_NAME\$" | awk '{print $NF}' | head -1)

          if [ -n "$RUNNING_BIN" ]; then
            RUNNING_CHECKSUM=$(shasum -a 256 "$RUNNING_BIN" 2>/dev/null | awk '{print $1}')

            if [ "$RUNNING_CHECKSUM" != "$EXPECTED_CHECKSUM" ]; then
              echo "❌ $proc: Running WRONG version (PID $PID)"
              echo "  → Run 'task reload PROC=$proc' to update"
              ERRORS=$((ERRORS + 1))
            else
              echo "✓ $proc: Running correct version (PID $PID)"
            fi
          fi
        done

        echo ""
        if [ $ERRORS -gt 0 ]; then
          echo "❌ $ERRORS processes need reload"
          exit 1
        else
          echo "✅ All running processes match disk versions"
        fi

  logs:
    desc: "Tail logs for a process (usage: task logs PROC=nats)"
    cmds:
      - task pc:logs PROC={{.PROC}}

  start:
    desc: Start all services with Process Compose
    deps:
      - bin:verify
    cmds:
      - task pc:run

  start:attach:
    desc: Attach to running Process Compose instance (requires real TTY)
    cmds:
      - task pc:attach

  start:fg:
    desc: Start all services in foreground (no TUI)
    deps:
      - bin:verify
    cmds:
      - task pc:run:fg

  status:
    desc: Show status of all processes
    cmds:
      - task pc:status

  stop:
    desc: Stop all services
    cmds:
      - task pc:stop

  test:
    desc: Run tests for all subsystems
    cmds:
      - task arc:test
      - task docs:test
      - task gh:test
      - task liftbridge:test
      - task nats:test
      - task pc:test
      - task telegraf:test

  deps:
    desc: Download dependencies for all subsystems
    cmds:
      - task arc:deps
      - task docs:deps
      - task gh:deps
      - task liftbridge:deps
      - task nats:deps
      - task pc:deps
      - task telegraf:deps

  clean:
    desc: Clean all build artifacts
    cmds:
      - task arc:clean
      - task liftbridge:clean
      - task nats:clean
      - task telegraf:clean

  clean:data:
    desc: Clean all data directories
    cmds:
      - task arc:clean:data
      - task liftbridge:clean:data
      - task nats:clean:data
      - task telegraf:clean:data

  clean:src:
    desc: Clean all source directories
    cmds:
      - task arc:clean:src
      - task liftbridge:clean:src
      - task nats:clean:src
      - task telegraf:clean:src

  clean:all:
    desc: Clean everything (.src, .bin, .data)
    cmds:
      - task arc:clean:all
      - task liftbridge:clean:all
      - task nats:clean:all
      - task telegraf:clean:all

  package:
    desc: Package all binaries for release (parallel)
    vars:
      GOOS: '{{.GOOS | default OS}}'
      GOARCH: '{{.GOARCH | default ARCH}}'
      DIST: '{{.DIST | default .DIST_DIR}}'
    cmds:
      - mkdir -p {{.DIST}}
      - for: [arc, gh, liftbridge, nats, pc, sync, telegraf]
        task: '{{.ITEM}}:package'
        vars:
          GOOS: '{{.GOOS}}'
          GOARCH: '{{.GOARCH}}'
          DIST: '{{.DIST}}'

  # Sync tasks (version automation)
  sync:check:
    desc: Check subsystems for upstream updates (manual testing)
    cmds:
      - sync/.bin/sync check {{.SUBSYSTEM | default "all"}}

  sync:update:
    desc: Update subsystem with available update (called by webhook)
    vars:
      SUBSYSTEM: '{{.SUBSYSTEM}}'
    cmds:
      - |
        # Update specific subsystem (INCREMENTAL)
        if [ -z "{{.SUBSYSTEM}}" ]; then
          echo "❌ SUBSYSTEM not specified"
          exit 1
        fi

        echo "▶ Updating {{.SUBSYSTEM}}..."

        # DEV mode: rebuild from source
        if [ -d "{{.SUBSYSTEM}}/.src" ]; then
          task {{.SUBSYSTEM}}:src:update
          task {{.SUBSYSTEM}}:bin:build
        # USER mode: download pre-built binary
        else
          task {{.SUBSYSTEM}}:bin:download
        fi

        task bin:verify
        task reload PROC={{.SUBSYSTEM}}

  # CI-specific tasks
  ci:dist:
    desc: Output the DIST_DIR for CI to use
    cmds:
      - echo "{{.DIST_DIR}}"
    silent: true

  ci:
    desc: Main CI entry point - runs build, test, package, release, pages
    cmds:
      - task: ci:build
      - task: ci:test
      - task: ci:package
      - task: ci:release
      - task: ci:pages

  ci:build:
    desc: CI build step - ensure CI subsystem binaries exist
    cmds:
      - task: ci:ensure
      - task: ci:verify

  ci:verify:
    desc: Verify CI subsystem binaries exist
    cmds:
      - |
        echo "=== CI Binary Verification ==="
        ERRORS=0
        for subsystem in {{.SUBSYSTEMS_CI}}; do
          # Get binary path
          BINARY_PATH="$subsystem/.bin"

          # Check binary directory exists
          if [ ! -d "$BINARY_PATH" ]; then
            echo "❌ $subsystem: Binary directory not found"
            ERRORS=$((ERRORS + 1))
            continue
          fi

          # Check at least one binary exists
          if ! ls "$BINARY_PATH"/* >/dev/null 2>&1; then
            echo "❌ $subsystem: No binaries found"
            ERRORS=$((ERRORS + 1))
            continue
          fi

          echo "✓ $subsystem: binary exists"
        done

        if [ $ERRORS -gt 0 ]; then
          echo "❌ $ERRORS subsystems have issues"
          exit 1
        fi
        echo "✅ All CI binaries verified"

  ci:test:
    desc: CI test step - run regression tests (skipped for now)
    cmds:
      - echo "▶ CI tests skipped (requires full service stack)"

  ci:package:
    desc: CI package step - package CI subsystem binaries
    cmds:
      - mkdir -p {{.DIST_DIR}}
      - for: { var: SUBSYSTEMS_CI }
        task: '{{.ITEM}}:package'

  ci:pages:
    desc: CI pages step - build docs for GitHub Pages
    cmds:
      - echo "▶ Building docs for GitHub Pages..."
      - task: docs:build
      - echo "✅ Docs built in docs/.dist"

  ci:release:
    desc: CI release step - upload CI subsystem binaries to GitHub releases
    cmds:
      - for: { var: SUBSYSTEMS_CI }
        task: release:binary
        vars:
          SUBSYSTEM: '{{.ITEM}}'



  install:deps:
    desc: Install required tools (hugo, gh, process-compose)
    cmds:
      - task docs:ensure
      - task gh:ensure
      - task pc:ensure
    status:
      - command -v hugo
      - test -f gh/.bin/gh
      - command -v process-compose


  manifest:
    desc: Show pinned versions vs installed versions
    cmds:
      - |
        echo "=== Subsystem Versions ==="
        echo ""
        echo "SUBSYSTEM     PINNED       SOURCE            BINARY"
        echo "---------     ------       ------            ------"
        echo "nats          {{.NATS_VERSION | default "v2.10.24"}}    $([ -d nats/.src/.git ] && git -C nats/.src describe --tags 2>/dev/null || echo '-')    $(cat nats/.bin/.version 2>/dev/null || echo '-')"
        echo "liftbridge    {{.LB_VERSION | default "v1.10.0"}}     $([ -d liftbridge/.src/.git ] && git -C liftbridge/.src describe --tags 2>/dev/null || echo '-')     $(cat liftbridge/.bin/.version 2>/dev/null || echo '-')"
        echo "arc           {{.ARC_VERSION | default "main"}}         $([ -d arc/.src/.git ] && git -C arc/.src rev-parse --short HEAD 2>/dev/null || echo '-')         $(cat arc/.bin/.version 2>/dev/null || echo '-')"
        echo "telegraf      {{.TG_VERSION | default "master"}}       $([ -d telegraf/.src/.git ] && git -C telegraf/.src rev-parse --short HEAD 2>/dev/null || echo '-')       $(cat telegraf/.bin/.version 2>/dev/null || echo '-')"

  github:pages:
    desc: Enable GitHub Pages (idempotent)
    deps: [gh:ensure]
    cmds:
      - |
        if gh/.bin/gh api repos/{{.RELEASE_REPO}}/pages 2>/dev/null | grep -q '"build_type":"workflow"'; then
          echo "GitHub Pages already enabled with Actions"
        else
          echo "Enabling GitHub Pages..."
          gh/.bin/gh api repos/{{.RELEASE_REPO}}/pages -X POST -f build_type=workflow 2>/dev/null || \
          gh/.bin/gh api repos/{{.RELEASE_REPO}}/pages -X PUT -f build_type=workflow
        fi
    status:
      - gh/.bin/gh api repos/{{.RELEASE_REPO}}/pages 2>/dev/null | grep -q '"build_type":"workflow"'

  release:
    desc: Create a GitHub release with packaged binaries
    vars:
      GOOS: '{{.GOOS | default OS}}'
      GOARCH: '{{.GOARCH | default ARCH}}'
      TAG: '{{.TAG}}'
    preconditions:
      - sh: test -n "{{.TAG}}"
        msg: "TAG is required (usage: task release TAG=v1.0.0)"
    cmds:
      - task: package
        vars:
          GOOS: '{{.GOOS}}'
          GOARCH: '{{.GOARCH}}'
      - gh/.bin/gh release create {{.TAG}} {{.DIST_DIR}}/* --generate-notes

  release:binary:
    desc: "Release subsystem binary (usage: task release:binary SUBSYSTEM=nats)"
    vars:
      SUBSYSTEM: '{{.SUBSYSTEM}}'
    preconditions:
      - sh: test -n "{{.SUBSYSTEM}}"
        msg: "SUBSYSTEM is required"
    cmds:
      - task: '{{.SUBSYSTEM}}:package'
      - |
        VERSION=$(task {{.SUBSYSTEM}}:config:version 2>/dev/null || echo "latest")
        RELEASE_TAG="{{.SUBSYSTEM}}-${VERSION}"

        # Create release if it doesn't exist
        gh/.bin/gh release view "$RELEASE_TAG" --repo {{.RELEASE_REPO}} >/dev/null 2>&1 || \
          gh/.bin/gh release create "$RELEASE_TAG" --repo {{.RELEASE_REPO}} --title "{{.SUBSYSTEM}} ${VERSION}" --notes "Binary release for {{.SUBSYSTEM}} ${VERSION}"

        # Upload binary
        gh/.bin/gh release upload "$RELEASE_TAG" --repo {{.RELEASE_REPO}} {{.DIST_DIR}}/{{.SUBSYSTEM}}*-{{OS}}-{{ARCH}}.tar.gz --clobber || \
          gh/.bin/gh release upload "$RELEASE_TAG" --repo {{.RELEASE_REPO}} {{.DIST_DIR}}/*-{{OS}}-{{ARCH}}.tar.gz --clobber

  release:all:
    desc: Release all subsystem binaries
    cmds:
      - for: [arc, gh, liftbridge, nats, pc, sync, telegraf]
        task: release:binary
        vars:
          SUBSYSTEM: '{{.ITEM}}'

  package:bundle:
    desc: Create platform bundle with all binaries
    vars:
      GOOS: '{{.GOOS | default OS}}'
      GOARCH: '{{.GOARCH | default ARCH}}'
    cmds:
      - mkdir -p {{.DIST_DIR}}/bundle
      - |
        # Collect all binaries into bundle
        for subsystem in arc liftbridge nats pc sync telegraf; do
          if [ -d "$subsystem/.bin" ]; then
            cp $subsystem/.bin/* {{.DIST_DIR}}/bundle/ 2>/dev/null || true
          fi
        done
      - tar -czvf {{.DIST_DIR}}/plat-telemetry-{{.GOOS}}-{{.GOARCH}}.tar.gz -C {{.DIST_DIR}}/bundle .
      - rm -rf {{.DIST_DIR}}/bundle

  reload:
    desc: "Reload a service after binary update (usage: task reload PROC=nats)"
    vars:
      PROC: '{{.PROC | default "nats"}}'
    cmds:
      - pc/.bin/process-compose process stop {{.PROC}} -U -u pc/.pc.sock
      - sleep 2
      - pc/.bin/process-compose process start {{.PROC}} -U -u pc/.pc.sock

  test:reload:snapshot:
    desc: Capture current state (PIDs, versions, checksums)
    cmds:
      - mkdir -p .test-results
      - |
        echo "=== Binary Hot-Reload Snapshot ===" > .test-results/snapshot.txt
        echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> .test-results/snapshot.txt
        echo "" >> .test-results/snapshot.txt

        for proc in arc liftbridge nats telegraf; do
          echo "=== $proc ===" >> .test-results/snapshot.txt

          # Get process info from PC
          pc/.bin/process-compose process get $proc -U -u pc/.pc.sock >> .test-results/snapshot.txt 2>&1 || echo "Process not running" >> .test-results/snapshot.txt

          # Get binary version
          if [ -f $proc/.bin/.version ]; then
            cat $proc/.bin/.version >> .test-results/snapshot.txt
          else
            echo "No version file" >> .test-results/snapshot.txt
          fi

          echo "" >> .test-results/snapshot.txt
        done

        echo "Snapshot saved to .test-results/snapshot.txt"

  test:reload:verify:
    desc: Verify process reloaded with new binary
    vars:
      PROC: '{{.PROC | default "nats"}}'
    cmds:
      - |
        echo "=== Verifying {{.PROC}} reload ==="

        # Check process is running
        if ! pc/.bin/process-compose process get {{.PROC}} -U -u pc/.pc.sock 2>/dev/null | grep -q "Running"; then
          echo "❌ ERROR: {{.PROC}} not in Running state"
          exit 1
        fi
        echo "✅ Process is Running"

        # Check version file exists
        if [ ! -f {{.PROC}}/.bin/.version ]; then
          echo "❌ ERROR: No .version file found"
          exit 1
        fi
        echo "✅ Version file exists"

        # Display version info
        echo "Binary info:"
        cat {{.PROC}}/.bin/.version

        echo "✅ {{.PROC}} reload verified"

  test:reload:diff:
    desc: Show what changed between snapshots
    cmds:
      - |
        if [ ! -f .test-results/snapshot-before.txt ] || [ ! -f .test-results/snapshot-after.txt ]; then
          echo "ERROR: Missing snapshot files. Run test:reload:snapshot first."
          exit 1
        fi

        echo "=== Changes Detected ==="
        diff .test-results/snapshot-before.txt .test-results/snapshot-after.txt || true

  test:reload:single:nats:
    desc: Test NATS single reload
    cmds:
      - task test:reload:snapshot
      - mv .test-results/snapshot.txt .test-results/snapshot-before.txt
      - echo "Rebuilding NATS binary..."
      - rm -f nats/.bin/nats-server nats/.bin/.version
      - task nats:bin:build
      - echo "Reloading NATS..."
      - task reload PROC=nats
      - sleep 5
      - task test:reload:snapshot
      - mv .test-results/snapshot.txt .test-results/snapshot-after.txt
      - task test:reload:verify PROC=nats
      - task test:reload:diff
      - echo "✅ NATS single reload test PASSED"

  test:reload:single:arc:
    desc: Test arc single reload
    cmds:
      - task test:reload:snapshot
      - mv .test-results/snapshot.txt .test-results/snapshot-before.txt
      - echo "Rebuilding arc binary..."
      - rm -f arc/.bin/arc arc/.bin/.version
      - task arc:bin:build
      - echo "Reloading arc..."
      - task reload PROC=arc
      - sleep 5
      - task test:reload:snapshot
      - mv .test-results/snapshot.txt .test-results/snapshot-after.txt
      - task test:reload:verify PROC=arc
      - task test:reload:diff
      - echo "✅ arc single reload test PASSED"

  test:reload:single:liftbridge:
    desc: Test liftbridge single reload
    cmds:
      - task test:reload:snapshot
      - mv .test-results/snapshot.txt .test-results/snapshot-before.txt
      - echo "Rebuilding liftbridge binary..."
      - rm -f liftbridge/.bin/liftbridge liftbridge/.bin/.version
      - task liftbridge:bin:build
      - echo "Reloading liftbridge..."
      - task reload PROC=liftbridge
      - sleep 5
      - task test:reload:snapshot
      - mv .test-results/snapshot.txt .test-results/snapshot-after.txt
      - task test:reload:verify PROC=liftbridge
      - task test:reload:diff
      - echo "✅ liftbridge single reload test PASSED"

  test:reload:single:telegraf:
    desc: Test telegraf single reload
    cmds:
      - task test:reload:snapshot
      - mv .test-results/snapshot.txt .test-results/snapshot-before.txt
      - echo "Rebuilding telegraf binary..."
      - rm -f telegraf/.bin/telegraf telegraf/.bin/.version
      - task telegraf:bin:build
      - echo "Reloading telegraf..."
      - task reload PROC=telegraf
      - sleep 5
      - task test:reload:snapshot
      - mv .test-results/snapshot.txt .test-results/snapshot-after.txt
      - task test:reload:verify PROC=telegraf
      - task test:reload:diff
      - echo "✅ telegraf single reload test PASSED"

  test:reload:single:all:
    desc: Run all single reload tests
    cmds:
      - task test:reload:single:nats
      - task test:reload:single:arc
      - task test:reload:single:liftbridge
      - task test:reload:single:telegraf
      - echo "✅ All single reload tests PASSED"

  test:reload:multi:parallel:
    desc: Test parallel reload (arc + liftbridge)
    cmds:
      - task test:reload:snapshot
      - mv .test-results/snapshot.txt .test-results/snapshot-before.txt
      - echo "Rebuilding arc and liftbridge binaries in parallel..."
      - rm -f arc/.bin/arc arc/.bin/.version liftbridge/.bin/liftbridge liftbridge/.bin/.version
      - task arc:bin:build & task liftbridge:bin:build & wait
      - echo "Reloading arc and liftbridge in parallel..."
      - task reload PROC="arc & task reload PROC="liftbridge & wait
      - sleep 5
      - task test:reload:snapshot
      - mv .test-results/snapshot.txt .test-results/snapshot-after.txt
      - task test:reload:verify PROC=arc
      - task test:reload:verify PROC=liftbridge
      - task test:reload:diff
      - echo "✅ Parallel reload test PASSED"

  test:reload:multi:cascade:
    desc: Test cascade reload (NATS → liftbridge)
    cmds:
      - task test:reload:snapshot
      - mv .test-results/snapshot.txt .test-results/snapshot-before.txt
      - echo "Rebuilding NATS binary..."
      - rm -f nats/.bin/nats-server nats/.bin/.version
      - task nats:bin:build
      - echo "Reloading NATS..."
      - task reload PROC=nats
      - sleep 5
      - echo "Rebuilding liftbridge binary..."
      - rm -f liftbridge/.bin/liftbridge liftbridge/.bin/.version
      - task liftbridge:bin:build
      - echo "Reloading liftbridge..."
      - task reload PROC=liftbridge
      - sleep 5
      - task test:reload:snapshot
      - mv .test-results/snapshot.txt .test-results/snapshot-after.txt
      - task test:reload:verify PROC=nats
      - task test:reload:verify PROC=liftbridge
      - task test:reload:diff
      - echo "✅ Cascade reload test PASSED"

  test:reload:multi:all:
    desc: Test all 4 binaries reloaded simultaneously
    cmds:
      - task test:reload:snapshot
      - mv .test-results/snapshot.txt .test-results/snapshot-before.txt
      - echo "Rebuilding all 4 binaries..."
      - rm -f arc/.bin/arc arc/.bin/.version
      - rm -f liftbridge/.bin/liftbridge liftbridge/.bin/.version
      - rm -f nats/.bin/nats-server nats/.bin/.version
      - rm -f telegraf/.bin/telegraf telegraf/.bin/.version
      - task arc:bin:build & task liftbridge:bin:build & task nats:bin:build & task telegraf:bin:build & wait
      - echo "Reloading all 4 services..."
      - task reload PROC="nats
      - sleep 5
      - task reload PROC="liftbridge
      - sleep 3
      - task reload PROC="arc & task reload PROC="telegraf & wait
      - sleep 5
      - task test:reload:snapshot
      - mv .test-results/snapshot.txt .test-results/snapshot-after.txt
      - task test:reload:verify PROC=arc
      - task test:reload:verify PROC=liftbridge
      - task test:reload:verify PROC=nats
      - task test:reload:verify PROC=telegraf
      - task test:reload:diff
      - echo "✅ Multi-all reload test PASSED"

  test:reload:rapid:nats:
    desc: Rapid NATS reloads (10x in 60s)
    cmds:
      - |
        echo "Starting rapid reload test (10 iterations)..."
        for i in {1..10}; do
          echo "=== Iteration $i/10 ==="
          rm -f nats/.bin/nats-server nats/.bin/.version
          task nats:bin:build
          task reload PROC=nats
          sleep 5

          # Verify still running
          if ! pc/.bin/process-compose process get nats -U -u pc/.pc.sock 2>/dev/null | grep -q "Running"; then
            echo "❌ FAILED at iteration $i - NATS not running"
            exit 1
          fi
          echo "✅ Iteration $i complete"
        done
        echo "✅ Rapid reload test PASSED (10/10 successful)"

  test:reload:rapid:all:
    desc: Rapid reload different services in sequence
    cmds:
      - |
        echo "Starting rapid sequential reload test..."
        SERVICES=(nats arc liftbridge telegraf)

        for i in {1..12}; do
          PROC=${SERVICES[$((i % 4))]}
          echo "=== Iteration $i/12: $PROC ==="

          rm -f $PROC/.bin/* $PROC/.bin/.version
          task $PROC:bin:build
          task reload PROC=$PROC
          sleep 3

          # Verify running
          if ! pc/.bin/process-compose process get $PROC -U -u pc/.pc.sock 2>/dev/null | grep -q "Running"; then
            echo "❌ FAILED at iteration $i - $PROC not running"
            exit 1
          fi
          echo "✅ Iteration $i complete"
        done
        echo "✅ Rapid sequential reload test PASSED (12/12 successful)"

  test:reload:fail:corrupt:
    desc: Test corrupt binary scenario
    cmds:
      - echo "Testing corrupt binary handling..."
      - rm -f nats/.bin/nats-server nats/.bin/.version
      - task nats:bin:build
      - rm -f nats/.bin/nats-server
      - echo "Attempting to reload with missing binary..."
      - task reload PROC="nats || echo "✅ Expected failure - cannot reload missing binary"
      - echo "Rebuilding binary..."
      - task nats:bin:build
      - task reload PROC=nats
      - sleep 5
      - task test:reload:verify PROC=nats
      - echo "✅ Corrupt binary test PASSED - system recovered"

  test:reload:phase3:
    desc: Run Phase 3 tests (single service reloads)
    cmds:
      - |
        echo "▶ Phase 3: Single Service Reloads"
        echo "Started: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
        echo ""

        START_TIME=$(date +%s)
        PASSED=0
        FAILED=0

        for test in nats arc liftbridge telegraf; do
          echo "▶ Running test:reload:single:$test"
          if task test:reload:single:$test; then
            echo "✅ PASSED: $test"
            PASSED=$((PASSED + 1))
          else
            echo "❌ FAILED: $test"
            FAILED=$((FAILED + 1))
          fi
          echo ""
        done

        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))

        echo "=== Phase 3 Summary ==="
        echo "Duration: ${DURATION}s"
        echo "TOTAL: $PASSED passed, $FAILED failed"

        if [ $FAILED -gt 0 ]; then
          echo "❌ PHASE 3 FAILED"
          exit 1
        else
          echo "✅ PHASE 3 PASSED"
        fi

  test:reload:phase4:
    desc: Run Phase 4 tests (multi-service reloads)
    cmds:
      - |
        echo "▶ Phase 4: Multi-Service Reloads"
        echo "Started: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
        echo ""

        START_TIME=$(date +%s)
        PASSED=0
        FAILED=0

        for test in parallel cascade all; do
          echo "▶ Running test:reload:multi:$test"
          if task test:reload:multi:$test; then
            echo "✅ PASSED: multi:$test"
            PASSED=$((PASSED + 1))
          else
            echo "❌ FAILED: multi:$test"
            FAILED=$((FAILED + 1))
          fi
          echo ""
        done

        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))

        echo "=== Phase 4 Summary ==="
        echo "Duration: ${DURATION}s"
        echo "TOTAL: $PASSED passed, $FAILED failed"

        if [ $FAILED -gt 0 ]; then
          echo "❌ PHASE 4 FAILED"
          exit 1
        else
          echo "✅ PHASE 4 PASSED"
        fi

  test:reload:phase5:
    desc: Run Phase 5 tests (rapid reload stress testing)
    cmds:
      - |
        echo "▶ Phase 5: Rapid Reload Stress Testing"
        echo "Started: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
        echo ""

        START_TIME=$(date +%s)

        echo "▶ Running test:reload:rapid:nats"
        if task test:reload:rapid:nats; then
          echo "✅ PASSED: rapid:nats"
          RESULT="PASSED"
        else
          echo "❌ FAILED: rapid:nats"
          RESULT="FAILED"
        fi

        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))

        echo ""
        echo "=== Phase 5 Summary ==="
        echo "Duration: ${DURATION}s"
        echo "Result: $RESULT"

        if [ "$RESULT" = "FAILED" ]; then
          echo "❌ PHASE 5 FAILED"
          exit 1
        else
          echo "✅ PHASE 5 PASSED"
        fi

  test:reload:phase6:
    desc: Run Phase 6 tests (failure scenario handling)
    cmds:
      - |
        echo "▶ Phase 6: Failure Scenario Handling"
        echo "Started: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
        echo ""

        START_TIME=$(date +%s)

        echo "▶ Running test:reload:fail:corrupt"
        if task test:reload:fail:corrupt; then
          echo "✅ PASSED: fail:corrupt"
          RESULT="PASSED"
        else
          echo "❌ FAILED: fail:corrupt"
          RESULT="FAILED"
        fi

        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))

        echo ""
        echo "=== Phase 6 Summary ==="
        echo "Duration: ${DURATION}s"
        echo "Result: $RESULT"

        if [ "$RESULT" = "FAILED" ]; then
          echo "❌ PHASE 6 FAILED"
          exit 1
        else
          echo "✅ PHASE 6 PASSED"
        fi

  test:reload:all:
    desc: Run complete regression suite
    cmds:
      - |
        echo "=== Binary Hot-Reload Regression Suite ==="
        echo "Started: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
        echo ""

        START_TIME=$(date +%s)

        mkdir -p .test-results
        echo "=== Binary Hot-Reload Regression Test Report ===" > .test-results/report.txt
        echo "Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> .test-results/report.txt
        echo "" >> .test-results/report.txt

        PASSED=0
        FAILED=0

        # Phase 3: Single reloads
        echo "Phase 3: Single Reloads" | tee -a .test-results/report.txt

        for test in nats arc liftbridge telegraf; do
          echo -n "  test:reload:single:$test ... " | tee -a .test-results/report.txt
          if task test:reload:single:$test > .test-results/test-$test.log 2>&1; then
            echo "✅ PASSED" | tee -a .test-results/report.txt
            PASSED=$((PASSED + 1))
          else
            echo "❌ FAILED" | tee -a .test-results/report.txt
            FAILED=$((FAILED + 1))
          fi
        done

        # Phase 4: Multi reloads
        echo "" | tee -a .test-results/report.txt
        echo "Phase 4: Multi Reloads" | tee -a .test-results/report.txt

        for test in parallel cascade all; do
          echo -n "  test:reload:multi:$test ... " | tee -a .test-results/report.txt
          if task test:reload:multi:$test > .test-results/test-multi-$test.log 2>&1; then
            echo "✅ PASSED" | tee -a .test-results/report.txt
            PASSED=$((PASSED + 1))
          else
            echo "❌ FAILED" | tee -a .test-results/report.txt
            FAILED=$((FAILED + 1))
          fi
        done

        # Phase 5: Rapid reloads
        echo "" | tee -a .test-results/report.txt
        echo "Phase 5: Rapid Reloads" | tee -a .test-results/report.txt

        echo -n "  test:reload:rapid:nats ... " | tee -a .test-results/report.txt
        if task test:reload:rapid:nats > .test-results/test-rapid-nats.log 2>&1; then
          echo "✅ PASSED" | tee -a .test-results/report.txt
          PASSED=$((PASSED + 1))
        else
          echo "❌ FAILED" | tee -a .test-results/report.txt
          FAILED=$((FAILED + 1))
        fi

        # Phase 6: Failure scenarios
        echo "" | tee -a .test-results/report.txt
        echo "Phase 6: Failure Scenarios" | tee -a .test-results/report.txt

        echo -n "  test:reload:fail:corrupt ... " | tee -a .test-results/report.txt
        if task test:reload:fail:corrupt > .test-results/test-fail-corrupt.log 2>&1; then
          echo "✅ PASSED" | tee -a .test-results/report.txt
          PASSED=$((PASSED + 1))
        else
          echo "❌ FAILED" | tee -a .test-results/report.txt
          FAILED=$((FAILED + 1))
        fi

        # Summary
        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))

        echo "" | tee -a .test-results/report.txt
        echo "=== Summary ===" | tee -a .test-results/report.txt
        echo "Duration: ${DURATION}s" | tee -a .test-results/report.txt
        echo "TOTAL: $PASSED passed, $FAILED failed" | tee -a .test-results/report.txt

        if [ $FAILED -gt 0 ]; then
          echo "" | tee -a .test-results/report.txt
          echo "❌ REGRESSION SUITE FAILED" | tee -a .test-results/report.txt
          exit 1
        else
          echo "" | tee -a .test-results/report.txt
          echo "✅ REGRESSION SUITE PASSED" | tee -a .test-results/report.txt
        fi

        cat .test-results/report.txt
