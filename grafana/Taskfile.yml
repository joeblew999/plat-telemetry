version: '3'

vars:
  GF_VERSION: '11.4.0'
  GF_DOWNLOAD_URL: 'https://dl.grafana.com/oss/release/grafana-{{.GF_VERSION}}.darwin-arm64.tar.gz'
  GF_BIN: '{{.TASKFILE_DIR}}/.bin'
  GF_DATA: '{{.TASKFILE_DIR}}/.data'

tasks:
  src:clone:
    desc: Download Grafana release
    cmds:
      - mkdir -p {{.GF_BIN}}
      - curl -L {{.GF_DOWNLOAD_URL}} | tar xz --strip-components=1 -C {{.GF_BIN}}
      - echo "{{.GF_VERSION}}" > {{.GF_BIN}}/.version
    status:
      - test -f {{.GF_BIN}}/bin/grafana-server

  src:update:
    desc: Re-download Grafana (update GF_VERSION var first)
    cmds:
      - rm -rf {{.GF_BIN}}
      - task: src:clone

  build:
    desc: Grafana is pre-built (no-op)
    status:
      - test -f {{.GF_BIN}}/bin/grafana-server
    cmds:
      - echo "Grafana is pre-built, nothing to compile"

  bin:download:
    desc: Download Grafana release (alias for src:clone)
    cmds:
      - mkdir -p {{.GF_BIN}}
      - curl -L {{.GF_DOWNLOAD_URL}} | tar xz --strip-components=1 -C {{.GF_BIN}}
      - echo "{{.GF_VERSION}}" > {{.GF_BIN}}/.version
    status:
      - test -f {{.GF_BIN}}/bin/grafana-server

  run:
    desc: Run Grafana server
    dir: '{{.TASKFILE_DIR}}'
    preconditions:
      - test -f {{.GF_BIN}}/bin/grafana-server
    cmds:
      - mkdir -p {{.GF_DATA}}/plugins
      - mkdir -p {{.GF_DATA}}/provisioning/dashboards
      - mkdir -p {{.GF_DATA}}/provisioning/datasources
      - '{{.GF_BIN}}/bin/grafana-server --homepath={{.GF_BIN}} --config={{.TASKFILE_DIR}}/grafana.ini cfg:default.paths.data={{.GF_DATA}} cfg:default.paths.plugins={{.GF_DATA}}/plugins cfg:default.paths.provisioning={{.GF_DATA}}/provisioning'

  test:
    desc: Check Grafana health
    preconditions:
      - curl -s http://localhost:3000/api/health >/dev/null
    cmds:
      - curl -s http://localhost:3000/api/health | jq .

  install:
    desc: Install Grafana plugins
    preconditions:
      - test -f {{.GF_BIN}}/bin/grafana-cli
    cmds:
      - '{{.GF_BIN}}/bin/grafana-cli --pluginsDir={{.GF_DATA}}/plugins plugins install grafana-clock-panel'

  deps:
    desc: No dependencies for Grafana binary
    cmds:
      - echo "Grafana is pre-built, no dependencies to download"

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf {{.GF_BIN}}
    status:
      - '! test -d {{.GF_BIN}}'

  clean:data:
    desc: Clean data directory
    cmds:
      - rm -rf {{.GF_DATA}}
    status:
      - '! test -d {{.GF_DATA}}'

  clean:src:
    desc: Clean source directory
    cmds:
      - rm -rf {{.GF_BIN}}
    status:
      - '! test -d {{.GF_BIN}}'

  clean:all:
    desc: Clean everything (.bin, .data)
    cmds:
      - rm -rf {{.GF_BIN}} {{.GF_DATA}}
