name: Test Build

on:
  workflow_dispatch:
    inputs:
      subsystem:
        description: 'Subsystem to build (nats, liftbridge, arc, telegraf, or all)'
        required: true
        default: 'nats'
        type: choice
        options:
          - nats
          - liftbridge
          - arc
          - telegraf
          - all
      platform:
        description: 'Platform to build'
        required: true
        default: 'linux'
        type: choice
        options:
          - linux
          - darwin
          - both

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
          - os: macos-latest
            goos: darwin
            goarch: arm64
        exclude:
          - os: ${{ inputs.platform == 'linux' && 'macos-latest' || 'none' }}
          - os: ${{ inputs.platform == 'darwin' && 'ubuntu-latest' || 'none' }}

    runs-on: ${{ matrix.os }}
    if: ${{ !cancelled() }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: false

      - name: Install Task
        run: go install github.com/go-task/task/v3/cmd/task@latest

      - name: Clone source
        run: |
          if [ "${{ inputs.subsystem }}" = "all" ]; then
            task src:clone
          else
            task src:clone:one SUBSYSTEM=${{ inputs.subsystem }}
          fi

      - name: Build
        run: |
          if [ "${{ inputs.subsystem }}" = "all" ]; then
            task nats:build &
            task liftbridge:build &
            task arc:build &
            task telegraf:build &
            wait
          else
            task bin:build:one SUBSYSTEM=${{ inputs.subsystem }}
          fi

      - name: Show result
        run: |
          echo "Built binaries:"
          find . -name "*.bin" -type d -exec ls -la {} \; 2>/dev/null || true
          ls -la */. 2>/dev/null | grep "\.bin" || true
