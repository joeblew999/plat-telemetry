version: "0.5"

# Run binaries directly for proper CPU/MEM stats in TUI
# Use shell commands to ensure dirs exist

processes:
  arc:
    command: |
      mkdir -p arc/.data
      ./arc/.bin/arc --config arc/arc.toml
    working_dir: .
    availability:
      restart: on_failure
      backoff_seconds: 5
    readiness_probe:
      http_get:
        host: 127.0.0.1
        port: 8000
        path: /health
      initial_delay_seconds: 3
      period_seconds: 5

  hugo:
    command: hugo server -D --bind 0.0.0.0 --port 1313
    working_dir: ./docs
    availability:
      restart: on_failure
      backoff_seconds: 5
    readiness_probe:
      http_get:
        host: 127.0.0.1
        port: 1313
        path: /plat-telemetry/
      initial_delay_seconds: 2
      period_seconds: 5

  grafana:
    command: |
      mkdir -p grafana/.data/plugins grafana/.data/provisioning/dashboards grafana/.data/provisioning/datasources
      ./grafana/.bin/bin/grafana-server \
        --homepath=./grafana/.bin \
        --config=./grafana/grafana.ini \
        cfg:default.paths.data=./grafana/.data \
        cfg:default.paths.plugins=./grafana/.data/plugins \
        cfg:default.paths.provisioning=./grafana/.data/provisioning
    working_dir: .
    depends_on:
      arc:
        condition: process_healthy
    availability:
      restart: on_failure
      backoff_seconds: 5
    readiness_probe:
      http_get:
        host: 127.0.0.1
        port: 3000
        path: /api/health
      initial_delay_seconds: 5
      period_seconds: 5

  liftbridge:
    command: |
      mkdir -p liftbridge/.data
      ./liftbridge/.bin/liftbridge --data-dir=./liftbridge/.data
    working_dir: .
    depends_on:
      nats:
        condition: process_healthy
    availability:
      restart: on_failure
      backoff_seconds: 5
    readiness_probe:
      exec:
        command: nc -z localhost 9292
      initial_delay_seconds: 3
      period_seconds: 5

  nats:
    command: |
      mkdir -p nats/.data
      ./nats/.bin/nats-server --config nats/nats.conf
    working_dir: .
    availability:
      restart: on_failure
      backoff_seconds: 5
    readiness_probe:
      http_get:
        host: 127.0.0.1
        port: 8222
        path: /healthz
      initial_delay_seconds: 2
      period_seconds: 5

  telegraf:
    command: |
      mkdir -p telegraf/.data
      ./telegraf/.bin/telegraf --config telegraf/telegraf.conf
    working_dir: .
    depends_on:
      arc:
        condition: process_healthy
      liftbridge:
        condition: process_healthy
    availability:
      restart: on_failure
      backoff_seconds: 5
    readiness_probe:
      exec:
        command: pgrep -f "telegraf --config"
      initial_delay_seconds: 3
      period_seconds: 5
